<div 
  class="relative w-full h-full flex flex-col items-center justify-center overflow-hidden bg-scratched-dark cursor-pointer"
  (dragover)="onDragOver($event)" 
  (drop)="onDrop($event)"
  (click)="triggerUpload()"
>
  <!-- Hidden File Input -->
  <input #fileInput type="file" class="hidden" (change)="onFileSelected($event)" />
  
  <!-- Webcam Background / Overlay -->
  <div class="absolute top-6 right-6 w-56 h-40 bg-black rounded-sm overflow-hidden border border-stone-600/50 shadow-2xl z-10 cursor-auto transition-all hover:border-stone-400" (click)="$event.stopPropagation()">
    <video #videoElement class="absolute w-full h-full object-cover transform -scale-x-100 opacity-80 mix-blend-screen" autoplay playsinline muted></video>
    <canvas #canvasElement class="absolute w-full h-full object-cover transform -scale-x-100 opacity-90"></canvas>
    <!-- Tech overlay for camera -->
    <div class="absolute inset-0 border-[1px] border-white/10 pointer-events-none">
      <div class="absolute top-0 left-0 w-2 h-2 border-t border-l border-white/40"></div>
      <div class="absolute top-0 right-0 w-2 h-2 border-t border-r border-white/40"></div>
      <div class="absolute bottom-0 left-0 w-2 h-2 border-b border-l border-white/40"></div>
      <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-white/40"></div>
    </div>
    <div class="absolute bottom-0 w-full bg-black/60 backdrop-blur-sm text-stone-300 font-mono text-[10px] p-1 text-center tracking-widest uppercase">
      {{ gestureService.currentGesture() }}
    </div>
  </div>

  <!-- Instructions -->
  <div class="absolute top-12 left-0 w-full text-center z-20 pointer-events-none px-4">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-b from-stone-100 to-stone-400 drop-shadow-sm mb-3 tracking-tight">
      {{ currentMessage() }}
    </h1>
    @if (paperState() === 'IDLE') {
      <p class="text-stone-500 font-mono text-sm tracking-widest uppercase opacity-70">Drop File / Click to Init</p>
    }
  </div>

  <!-- Reset Button -->
  @if (paperState() === 'ASHES') {
    <button 
      (click)="reset(); $event.stopPropagation()" 
      class="z-30 px-8 py-3 bg-stone-100 text-stone-900 rounded-sm font-bold tracking-widest hover:bg-white hover:scale-105 transition-all shadow-[0_0_20px_rgba(255,255,255,0.2)] cursor-pointer"
    >
      RESET SYSTEM
    </button>
  }

  <!-- Center Stage for Paper -->
  <div class="relative w-full max-w-lg h-96 flex items-center justify-center z-0">
    
    <!-- Shake Wrapper -->
    <div class="relative" [class.animate-shake]="isShaking()">
      
      <!-- The "Paper" Object -->
      <div class="relative transition-all duration-700 ease-[cubic-bezier(0.34,1.56,0.64,1)] origin-center"
          [class.opacity-0]="paperState() === 'IDLE' || paperState() === 'ASHES'"
          [class.scale-0]="paperState() === 'IDLE'"
      >
        <!-- Paper Appearance -->
        <div 
          class="w-64 h-80 bg-white shadow-2xl flex flex-col p-6 text-stone-800 relative transition-all duration-500 origin-center"
          [class.crumple-texture-base]="paperState() !== 'IDLE' && paperState() !== 'ACTIVE'"
          [class.paper-texture]="paperState() === 'ACTIVE'"
          [class.burning-effect]="paperState() === 'BURNING'"
          
          [style.filter]="
            paperState() === 'CRUMPLED_1' ? 'url(#crumple-noise-low)' : 
            paperState() === 'CRUMPLED_2' ? 'url(#crumple-noise-high)' : 
            paperState() === 'CRUMPLED_FINAL' ? 'url(#crumple-noise-high) brightness(0.9)' :
            'none'
          "
          
          [style.transform]="
            paperState() === 'CRUMPLED_1' ? 'scale(0.85) rotate(5deg)' :
            paperState() === 'CRUMPLED_2' ? 'scale(0.6) rotate(-10deg)' :
            paperState() === 'CRUMPLED_FINAL' || paperState() === 'BURNING' ? 'scale(0.4) rotate(180deg)' : 
            'scale(1)'
          "
          [style.borderRadius]="
            paperState() === 'CRUMPLED_1' ? '4px' :
            paperState() === 'CRUMPLED_2' ? '20% 30% 10% 40%' :
            paperState() === 'CRUMPLED_FINAL' || paperState() === 'BURNING' ? '45%' : 
            '1px'
          "
        >
          
          <!-- Content on Paper -->
          <div class="flex-1 overflow-hidden transition-opacity duration-300 relative z-10"
              [style.opacity]="paperState() === 'CRUMPLED_FINAL' ? '0.3' : '1'"
          >
            <div class="border-b-2 border-stone-300 mb-2 pb-1 flex justify-between items-end">
              <h2 class="font-mono text-sm font-bold uppercase truncate w-3/4">{{ fileName() || 'Untitled' }}</h2>
              <span class="text-[10px] text-stone-400">DOC-01</span>
            </div>
            <div class="text-[10px] text-stone-500 font-mono break-all mb-4">
              TYPE: {{ fileType() || 'UNKNOWN' }}
            </div>
            <div class="space-y-2">
              <div class="h-2 w-full bg-stone-100 rounded"></div>
              <div class="h-2 w-5/6 bg-stone-100 rounded"></div>
              <div class="h-2 w-4/6 bg-stone-100 rounded"></div>
              <div class="h-2 w-full bg-stone-100 rounded"></div>
            </div>
          </div>

          <!-- Fire Overlay (Only visible during burn) -->
          @if (paperState() === 'BURNING') {
            <div class="absolute inset-[-50px] bg-gradient-to-t from-orange-600 via-yellow-500 to-transparent rounded-full opacity-0 mix-blend-hard-light fire-overlay-anim pointer-events-none z-20"></div>
          }

          <!-- Wrinkle Shadows (CSS Overlay) -->
          @if (paperState() !== 'IDLE' && paperState() !== 'ACTIVE') {
            <div class="absolute inset-0 bg-gradient-to-br from-transparent via-stone-400/20 to-stone-900/30 pointer-events-none rounded-[inherit] z-10"></div>
          }

        </div>
      </div>
      
      <!-- Sparks System -->
      @if (paperState() === 'BURNING') {
        @for (spark of sparks(); track $index) {
          <div 
            class="absolute bg-orange-400 rounded-full shadow-[0_0_10px_orange]"
            [style.width.px]="4"
            [style.height.px]="4"
            [style.left.%]="spark.x"
            [style.top.%]="spark.y"
            [style.transform]="'scale(' + spark.scale + ')'"
            [style.animation]="'spark-fly ' + spark.duration + ' ease-out forwards'"
            [style.animationDelay]="spark.delay"
          >
            <style>
              @keyframes spark-fly {
                0% { opacity: 1; transform: translate(0, 0) scale(1); }
                100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
              }
            </style>
            <!-- Using inline styles for dynamic variables in animation -->
            <div [style.--tx.px]="spark.tx" [style.--ty.px]="spark.ty" class="w-full h-full"></div>
          </div>
        }
      }
    </div>
  </div>

</div>